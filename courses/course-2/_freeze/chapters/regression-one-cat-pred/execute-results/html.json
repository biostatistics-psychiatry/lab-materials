{
  "hash": "23557186e8e8bba26556d1a9d17fba34",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Chapter 3: Regression with a Categorical Predictor\"\nformat: html\neditor: visual\ntoc: true\ntoc-depth: 3\n---\n\n\n\n# Introduction\n\nIn the previous chapter, we studied regression with a **binary predictor**.\\\nIn this chapter, we extend that framework to a **categorical predictor with three levels**, called `trt`.\n\nThis is a common situation in experiments with more than two arms (e.g., waitlist vs two treatment variants). The main difference compared to the binary case is that the model now estimates:\n\n-   the expected outcome in a **reference group**\n-   the difference between each other group and the reference group\n\nYou will learn:\n\n-   how categorical predictors are represented using factors in R\n-   how to interpret intercepts and coefficients with 3+ groups\n-   how to obtain predicted values for each group\n-   how to compute and visualize pairwise group differences\n-   how linear (mean) and quantile (median) regression handle categorical predictors\n\n# 1. Packages and Data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) \nlibrary(broom) \nlibrary(quantreg) \nlibrary(marginaleffects) \nlibrary(here)\n```\n:::\n\n\n\n## Load data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- read.csv(here(\"data\", \"steps_clean.csv\"))\ndf <- df %>% rename(grp = group)\n```\n:::\n\n\n\nWe will again use the treatment indicator variable `trt` as our predictor. In the original data, this indicator has three levels:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(df$trt)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n     self-guided therapist-guided         waitlist \n              61               60               60 \n```\n\n\n:::\n:::\n\n\n\nTo make sure R treats `trt` as a categorical predictor, we convert it to a factor and choose a reference level.\n\nAs in the last chapter, we set `waitlist` as the reference group.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf$trt <- factor(df$trt,\nlevels = c(\"waitlist\", \"therapist-guided\", \"self-guided\"))\nlevels(df$trt)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"waitlist\"         \"therapist-guided\" \"self-guided\"     \n```\n\n\n:::\n:::\n\n\n\n# 2. Regression with a Categorical Predictor\n\nWith a categorical predictor with three levels, the regression model estimates:\n\n1.  the expected outcome in the reference group\n\n2.  the difference between each of the other groups and the reference group\n\n## 2.1 Model formula\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\nlsas_post ~ trt\n```\n\n\n:::\n:::\n\n\n\nThe R syntax is the same as with the binary predictor. However, when `trt` has three levels, R uses **dummy coding** by default (also called treatment coding).\n\nIf `waitlist` is the reference group, the linear regression model can be written:\n\n$$\nE(LSAS_{post}) = \\beta_0 + \\beta_1 I(trt= \"therapist-guided\") + \\beta_2 I(trt=\"self-guided)\n$$\n\nWhere:\n\n-   $\\beta_0$ is the expected outcome in the reference group (`waitlist`)\n\n-   $\\beta_1$ is the mean difference between therapist-guided and waitlist\n\n-   $\\beta_2$ is the mean difference between self-guided and waitlist\n\n| trt              | Predicted value     |\n|------------------|---------------------|\n| waitlist         | $\\beta_0$           |\n| therapist-guided | $\\beta_0 + \\beta_1$ |\n| self-guided      | $\\beta_0 + \\beta_2$ |\n\nSo the coefficients compare each treatment arm to the reference group.\n\n# 3. Linear Regression (Mean Differences)\n\n## 3.1 Fit the model\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod_lm <- lm(lsas_post ~ trt, data = df)\nsummary(mod_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = lsas_post ~ trt, data = df)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-64.448 -14.912  -1.352  14.088  62.648 \n\nCoefficients:\n                    Estimate Std. Error t value Pr(>|t|)    \n(Intercept)           78.448      3.062  25.623  < 2e-16 ***\ntrttherapist-guided  -21.096      4.409  -4.785 3.76e-06 ***\ntrtself-guided       -13.536      4.349  -3.113  0.00218 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 23.32 on 166 degrees of freedom\n  (12 observations deleted due to missingness)\nMultiple R-squared:  0.1248,\tAdjusted R-squared:  0.1143 \nF-statistic: 11.84 on 2 and 166 DF,  p-value: 1.561e-05\n```\n\n\n:::\n:::\n\n\n\n### Interpretation\n\n-   **Intercept**: estimated mean LSAS score in the waitlist group\n\n-   **trt coefficients**: estimated mean differences vs waitlist\n\nWe can verify group means directly:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>%\ngroup_by(trt) %>%\nsummarize(mean_lsas = mean(lsas_post, na.rm = TRUE))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 × 2\n  trt              mean_lsas\n  <fct>                <dbl>\n1 waitlist              78.4\n2 therapist-guided      57.4\n3 self-guided           64.9\n```\n\n\n:::\n:::\n\n\n\n## 3.2 Relationship to one-way ANOVA\n\nA linear regression with one categorical predictor (3+ groups) is equivalent to a one-way ANOVA:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(mod_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Variance Table\n\nResponse: lsas_post\n           Df Sum Sq Mean Sq F value    Pr(>F)    \ntrt         2  12873  6436.7   11.84 1.561e-05 ***\nResiduals 166  90247   543.7                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\nThe ANOVA table tests whether there is evidence that **at least one group mean differs**.\n\n# 4. Quantile Regression (quantile differences)\n\n## 4.1 Model formulation\n\nFor quantile regression at quantile $\\tau$:\n\n$$\nQ_{LSAS_{post}}(\\tau) =  \\beta_0,\\tau + \\beta_1, \\tau \\cdot I(trt = \"thearpist-guided\") + \\beta_2 \\cdot I(trt= \"self-guided\") \n$$\n\n-   $\\beta_0,\\tau$ = $\\tau$-th quantile in waitlist\n-   $\\beta_1,\\tau$ = $\\tau$-th quantile difference (therapist-guided − waitlist)\n-   $\\beta_2,\\tau$ = $\\tau$-th quantile difference (self-guided − waitlist)\n\n## 4.2 Fit a median regression\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod_rq <- rq(lsas_post ~ trt, tau = 0.5, data = df)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in rq.fit.br(x, y, tau = tau, ...): Solution may be nonunique\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(mod_rq)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in rq.fit.br(x, y, tau = tau, ci = TRUE, ...): Solution may be\nnonunique\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall: rq(formula = lsas_post ~ trt, tau = 0.5, data = df)\n\ntau: [1] 0.5\n\nCoefficients:\n                    coefficients lower bd  upper bd \n(Intercept)          77.00000     71.70143  84.59713\ntrttherapist-guided -24.00000    -31.74701 -16.62650\ntrtself-guided      -13.00000    -18.30306  -2.13129\n```\n\n\n:::\n:::\n\n\n\nVerify group medians directly:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>%\ngroup_by(trt) %>%\nsummarize(median_lsas = median(lsas_post, na.rm = TRUE))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 × 2\n  trt              median_lsas\n  <fct>                  <dbl>\n1 waitlist                77  \n2 therapist-guided        52.5\n3 self-guided             64  \n```\n\n\n:::\n:::\n\n\n\n# 5. Model Objects and Coefficients\n\n## 5.1 Linear regression object\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(mod_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"coefficients\"  \"residuals\"     \"effects\"       \"rank\"         \n [5] \"fitted.values\" \"assign\"        \"qr\"            \"df.residual\"  \n [9] \"na.action\"     \"contrasts\"     \"xlevels\"       \"call\"         \n[13] \"terms\"         \"model\"        \n```\n\n\n:::\n\n```{.r .cell-code}\ncoef(mod_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        (Intercept) trttherapist-guided      trtself-guided \n           78.44828           -21.09642           -13.53600 \n```\n\n\n:::\n:::\n\n\n\n-   `(Intercept)` → waitlist mean\n\n-   `trttherapist-guided` → mean difference vs waitlist\n\n-   `trtself-guided` → mean difference vs waitlist\n\n## 5.2 Quantile regression object\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoef(mod_rq)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        (Intercept) trttherapist-guided      trtself-guided \n                 77                 -24                 -13 \n```\n\n\n:::\n:::\n\n\n\nInterpretation is parallel, but for quantiles (e.g., medians).\n\n# 6. Predictions Using `marginaleffects`\n\nAs in the binary precitor case, `marginaleffects` makes it easy to get:\n\n-   predicted values for each group\n\n-   uncertainty (SEs and CIs)\n\n-   group differences as contrasts\n\n## 6.1 Predicted means by group (linear regression)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_predictions(mod_lm, by = \"trt\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n              trt Estimate Std. Error    z Pr(>|z|)     S 2.5 % 97.5 %\n waitlist             78.4       3.06 25.6   <0.001 478.6  72.4   84.4\n therapist-guided     57.4       3.17 18.1   <0.001 240.2  51.1   63.6\n self-guided          64.9       3.09 21.0   <0.001 323.4  58.9   71.0\n\nType: response\n```\n\n\n:::\n:::\n\n\n\n## 6.2 Predicted medians by group (quantile regression)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_predictions(mod_rq, by = \"trt\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n              trt Estimate Std. Error    z Pr(>|z|)     S 2.5 % 97.5 %\n waitlist               77       3.36 22.9   <0.001 383.1  70.4   83.6\n therapist-guided       53       4.07 13.0   <0.001 126.6  45.0   61.0\n self-guided            64       3.96 16.2   <0.001 193.0  56.2   71.8\n\nType: response\n```\n\n\n:::\n:::\n\n\n\n## 6.3 Group differences as contrasts\n\n### Mean differences (linear regression)\n\nWith 3 groups, you usually want **pairwise comparisons** between all groups:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_comparisons(mod_lm, by = \"trt\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n                    Contrast              trt Estimate Std. Error     z\n self-guided - waitlist      waitlist            -13.5       4.35 -3.11\n therapist-guided - waitlist waitlist            -21.1       4.41 -4.78\n self-guided - waitlist      therapist-guided    -13.5       4.35 -3.11\n therapist-guided - waitlist therapist-guided    -21.1       4.41 -4.78\n self-guided - waitlist      self-guided         -13.5       4.35 -3.11\n therapist-guided - waitlist self-guided         -21.1       4.41 -4.78\n Pr(>|z|)    S 2.5 % 97.5 %\n  0.00185  9.1 -22.1  -5.01\n  < 0.001 19.2 -29.7 -12.45\n  0.00185  9.1 -22.1  -5.01\n  < 0.001 19.2 -29.7 -12.45\n  0.00185  9.1 -22.1  -5.01\n  < 0.001 19.2 -29.7 -12.45\n\nTerm: trt\nType: response\n```\n\n\n:::\n:::\n\n\n\n## Median differences (quantile regression)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_comparisons(mod_rq, by = \"trt\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n                    Contrast              trt Estimate Std. Error     z\n self-guided - waitlist      waitlist              -13       5.19 -2.50\n therapist-guided - waitlist waitlist              -24       5.28 -4.55\n self-guided - waitlist      therapist-guided      -13       5.19 -2.50\n therapist-guided - waitlist therapist-guided      -24       5.28 -4.55\n self-guided - waitlist      self-guided           -13       5.19 -2.50\n therapist-guided - waitlist self-guided           -24       5.28 -4.55\n Pr(>|z|)    S 2.5 % 97.5 %\n   0.0123  6.3 -23.2  -2.82\n   <0.001 17.5 -34.3 -13.66\n   0.0123  6.3 -23.2  -2.82\n   <0.001 17.5 -34.3 -13.66\n   0.0123  6.3 -23.2  -2.82\n   <0.001 17.5 -34.3 -13.66\n\nTerm: trt\nType: response\n```\n\n\n:::\n:::\n\n\n\n# 7. Visualization\n\n## 7.1 Group means with confidence intervals\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nap <- avg_predictions(mod_lm, by = \"trt\") # save the means and CIs for each group as an object for plotting\n\nggplot(ap, aes(x = trt, y = estimate)) +\ngeom_point(size = 3) +\ngeom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +\nlabs(\nx = \"Treatment group\",\ny = \"Estimated Mean LSAS (95% CI)\",\ntitle = \"Estimated Group Means from Linear Regression\"\n) +\ntheme_minimal()\n```\n\n::: {.cell-output-display}\n![](regression-one-cat-pred_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n\n## 7.2 Group medians with confidence intervals\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nap <- avg_predictions(mod_rq, by = \"trt\") # save the medians and CIs for each group as an object for plotting\n\nggplot(ap, aes(x = trt, y = estimate)) +\ngeom_point(size = 3) +\ngeom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +\nlabs(\nx = \"Treatment group\",\ny = \"Estimated Median LSAS (95% CI)\",\ntitle = \"Estimated Group Medians from Quantile Regression\"\n) +\ntheme_minimal()\n```\n\n::: {.cell-output-display}\n![](regression-one-cat-pred_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n## 7.3 Mean differences (pairwise) with confidence intervals\n\nWith three groups, there is no single “treatment − control” difference.\\\nInstead, we visualize the **pairwise mean differences** between all groups.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncmp <- avg_comparisons(mod_lm, by = \"trt\") # save the mean differences and CIs as an object for plotting\ncmp\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n                    Contrast              trt Estimate Std. Error     z\n self-guided - waitlist      waitlist            -13.5       4.35 -3.11\n therapist-guided - waitlist waitlist            -21.1       4.41 -4.78\n self-guided - waitlist      therapist-guided    -13.5       4.35 -3.11\n therapist-guided - waitlist therapist-guided    -21.1       4.41 -4.78\n self-guided - waitlist      self-guided         -13.5       4.35 -3.11\n therapist-guided - waitlist self-guided         -21.1       4.41 -4.78\n Pr(>|z|)    S 2.5 % 97.5 %\n  0.00185  9.1 -22.1  -5.01\n  < 0.001 19.2 -29.7 -12.45\n  0.00185  9.1 -22.1  -5.01\n  < 0.001 19.2 -29.7 -12.45\n  0.00185  9.1 -22.1  -5.01\n  < 0.001 19.2 -29.7 -12.45\n\nTerm: trt\nType: response\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(cmp, aes(y = contrast, x = estimate)) +\ngeom_vline(xintercept = 0, linetype = \"dashed\") +\ngeom_point(size = 3) +\ngeom_errorbar(aes(xmin = conf.low, xmax = conf.high), width = 0.1) +\nlabs(\ny = \"\",\nx = \"Estimated Mean Difference (95% CI)\",\ntitle = \"Pairwise Mean Differences (Linear Regression)\"\n) +\ntheme_minimal()\n```\n\n::: {.cell-output-display}\n![](regression-one-cat-pred_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\n\n## 7.4 Median differences (pairwise) with confidence intervals\n\nNow we do the same visualization for **pairwise median differences** from quantile regression.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncmp <- avg_comparisons(mod_rq, by = \"trt\") # save the median differences and CIs as an object for plotting\ncmp\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n                    Contrast              trt Estimate Std. Error     z\n self-guided - waitlist      waitlist              -13       5.19 -2.50\n therapist-guided - waitlist waitlist              -24       5.28 -4.55\n self-guided - waitlist      therapist-guided      -13       5.19 -2.50\n therapist-guided - waitlist therapist-guided      -24       5.28 -4.55\n self-guided - waitlist      self-guided           -13       5.19 -2.50\n therapist-guided - waitlist self-guided           -24       5.28 -4.55\n Pr(>|z|)    S 2.5 % 97.5 %\n   0.0123  6.3 -23.2  -2.82\n   <0.001 17.5 -34.3 -13.66\n   0.0123  6.3 -23.2  -2.82\n   <0.001 17.5 -34.3 -13.66\n   0.0123  6.3 -23.2  -2.82\n   <0.001 17.5 -34.3 -13.66\n\nTerm: trt\nType: response\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(cmp, aes(y = contrast, x = estimate)) +\ngeom_vline(xintercept = 0, linetype = \"dashed\") +\ngeom_point(size = 3) +\ngeom_errorbar(aes(xmin = conf.low, xmax = conf.high), width = 0.1) +\nlabs(\ny = \"\",\nx = \"Estimated Median Difference (95% CI)\",\ntitle = \"Pairwise Median Differences (Quantile Regression)\"\n) +\ntheme_minimal()\n```\n\n::: {.cell-output-display}\n![](regression-one-cat-pred_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\n\n# Summary\n\nIn this chapter you learned:\n\n-   how to fit regression models with a categorical predictor (3 levels)\n\n-   how dummy coding works (reference group + differences)\n\n-   how linear regression estimates **mean differences** across groups\n\n-   how quantile regression estimates **quantile differences** across groups\n\n-   how to extract predicted values and contrasts using `marginaleffects`\n\n-   how to visualize group means/medians and pairwise differences with confidence intervals\n",
    "supporting": [
      "regression-one-cat-pred_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}