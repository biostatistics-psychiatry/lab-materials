---
title: "Chapter 5: Regression with Two Binary Predictors"
format: 
   html:
     df-print: kable
toc: true
toc-depth: 3
number-sections: true
---

# Introduction

In the previous chapters, we studied regression models with:

-   a single binary predictor
-   a categorical predictor with multiple levels
-   a numeric predictor

In this chapter, we extend these ideas to **two binary predictors**.\
This allows us to introduce the important concept of **conditional effects** and to distinguish between:

-   **additive models** (no interaction)
-   **interaction models** (effect modification)

You will learn:

-   how to interpret models with two binary predictors
-   what *conditional effects* mean
-   how interactions change interpretation
-   how to estimate and visualize effects using `marginaleffects`
-   how linear and quantile regression handle interactions

# Packages and Data

```{r, message=FALSE, warning=FALSE}
#| label: setup-packages
library(tidyverse)
library(broom)
library(quantreg)
library(marginaleffects)
library(here)
```

```{r}
#| label: setup-packages-rendering
#| message: false
#| warning: false
#| echo: false
options(
  marginaleffects_print_omit = c("s.value"),
  marginaleffects_print_style = ifelse(interactive(), "summary", "tinytable")
)
```

## Load data

```{r}
#| label: load-data
#| message: false
#| warning: false
df_clean <- read_csv2(here("data", "steps_clean.csv"))
```

One of the predictors will be treatment group. To get a binary variable (i.e., one with only two levels), we subset the data to include only participants in the therapist-guided or wait-list conditions. We'll call this reduced dataset `df_red`.

```{r}
#| label: subset-binary-trt
df_red <- filter(df_clean, trt %in% c("therapist-guided", "waitlist"))
```

We convert `trt` to a factor and set `waitlist` as the reference group.

```{r}
#| label: set-trt-factor
df_red <- df_red |>
  mutate(
    trt = factor(trt, levels = c("waitlist", "therapist-guided"))
  )
```

The other predictor will be depression severity. To get a binary variable, we dichotomize the PHQ-9 measure at screening using the sample median (for illustration only).

```{r}
#| label: create-dep-bin
df_red <- df_red |>
  mutate(
    dep_bin = factor(
      phq9_screen > median(phq9_screen, na.rm = TRUE),
      levels = c(FALSE, TRUE),
      labels = c("Low", "High")
    )
  )

table(df_red$dep_bin) # show distribution
```

# Two Binary Predictors without Interaction (Additive Model)

We begin with a model that includes both predictors **without** an interaction.

## Model formula

```{r}
#| label: formula-additive
lsas_post ~ trt + dep_bin
```

This corresponds to the linear regression model for the conditional mean:

$$
\begin{aligned}
\mathbb{E}(LSAS_{post,i} \,\mid\, trt_i,\; dep\_bin_i) =& \beta_0 + \\
& \beta_1\, \mathbf{1}\{\text{trt}_i = \text{therapist-guided}\} + \\
& \beta_2\, \mathbf{1}\{\text{dep\_bin}_i = \text{High}\}
\end{aligned}
$$

Where:

-   $\beta_0$: mean outcome in the reference group (waitlist & Low depression)
-   $\beta_1$: conditional treatment effect, holding depression constant
-   $\beta_2$: conditional depression effect, holding treatment constant

## Interpretation of conditional effects

In this model:

-   the effect of treatment is assumed to be **the same** for low and high depression
-   the effect of depression is assumed to be **the same** in both treatment groups

This is called an **additive model** (because the effects of the two predictors are added to each other). Under additivity, the treatment effect is assumed the same in Low and High depression groups, and the depression effect is assumed the same in both treatment groups.

# Linear Regression without Interaction

## Fit the model

```{r}
#| label: fit-lm-additive
mod_lm_add <- lm(lsas_post ~ trt + dep_bin, data = df_red)
summary(mod_lm_add)
```

### Interpretation

-   **Intercept**: mean LSAS at post-treatment in waitlist & low depression.
-   **trt coefficient**: mean difference between therapist-guided and waitlist, adjusted for depression. The mean LSAS post score in the therapist-guided group is \~21 points lower than in the waitlist group.
-   **dep_bin coefficient**: mean difference between High and Low depression, adjusted for treatment. The mean LSAS post score in the Low-depression group is \~8 points lower than in the High-depression group.

## Predicted means by group

We can now use the `marginaleffects` package to get the estimated means for each of the four groups, i.e., the *conditional* estimated means.

```{r}
#| label: avg-preds-additive
avg_predictions(mod_lm_add, by = c("trt", "dep_bin"))
```

## Treatment effect as a conditional contrast

We can get the conditional treatment effects across both groups using the `marginaleffects` package.

```{r}
#| label: avg-comparisons-additive-by-dep
avg_comparisons(mod_lm_add,
  variables = "trt",
  by = "dep_bin"
)
```

Since we specified the model as additive, the treatment effect is the same in both depression groups.

## Treatment effect as a marginal contrast

The marginal contrast averages over the conditional contrasts. Since these are the same in this model, the marginal effect will be identical to the conditional effects.

```{r}
#| label: avg-comparisons-additive-marginal
avg_comparisons(mod_lm_add, variables = "trt")
```

# Adding an Interaction

Now we allow the treatment effect to differ depending on depression severity.

## Model formula with interaction

```{r}
#| label: formula-interaction
lsas_post ~ trt * dep_bin
```

Which expands, using indicator functions, to the conditional mean:

$$
\begin{aligned}
\mathbb{E}(LSAS_{post,i} \,\mid\, trt_i,\; dep\_bin_i) =& \beta_0 + \\
& \beta_1\, \mathbf{1}\{\text{trt}_i = \text{therapist-guided}\} + \\
& \beta_2\, \mathbf{1}\{\text{dep\_bin}_i = \text{High}\} + \\
& \beta_3\, \mathbf{1}\{\text{trt}_i = \text{therapist-guided}\}\times \mathbf{1}\{\text{dep\_bin}_i = \text{High}\}
\end{aligned}
$$

-   $\beta_3$ is the **interaction term**
-   it captures how the treatment effect changes with depression level

We now allow for different treatment effects **depending on the level of depression**, rather than the treatment effect simply adding to the depression effect as in the additive model.

# Linear Regression with Interaction

## Fit the interaction model

```{r}
#| label: fit-lm-interaction
mod_lm_int <- lm(lsas_post ~ trt * dep_bin, data = df_red)
summary(mod_lm_int)
```

### Interpretation

-   The treatment effect is **conditional on depression severity**
-   Main effects are now interpreted **at the reference level** of the other variable
-   The interaction coefficient represents the **difference in the treatment effect between participants with high versus low depression**. It tells us that the treatment effect is \~6 points greater in the high-depression group compared with the treatment effect in the low-depression group.

## Conditional treatment effects

```{r}
#| label: avg-comparisons-int-by-dep
avg_comparisons(
  mod_lm_int,
  variables = "trt",
  by = "dep_bin"
)
```

These estimates answer:

> What is the treatment effect **within each level of depression severity** (low vs high)?

In this interaction model, the treatment effect is allowed to differ depending on baseline depression.

## Marginal treatment effects

```{r}
#| label: avg-comparisons-int-marginal
avg_comparisons(
  mod_lm_int,
  variables = "trt"
)
```

This estimate is the **marginal (population-average) treatment effect.** It is obtained by averaging the conditional treatment effects over the observed distribution of low and high depression in the sample. Because we allowed the effect to differ between the depression groups, this estimate is no longer identical to the conditional estimate of `trt` from the model, or to the conditional contrasts above.

# Quantile Regression with Two Binary Predictors

Now let's do the same thing with quantile regression.

## Additive model (median differences)

```{r, warning= FALSE}
#| label: fit-rq-additive
mod_rq_add <- rq(
  lsas_post ~ trt + dep_bin,
  tau = 0.5,
  data = df_red
)
summary(mod_rq_add)
```

## Interaction model (median differences)

```{r, warning= FALSE}
#| label: fit-rq-interaction
mod_rq_int <- rq(
  lsas_post ~ trt * dep_bin,
  tau = 0.5,
  data = df_red
)
summary(mod_rq_int)
```

## Conditional median treatment effects

```{r}
#| label: rq-avg-comparisons-int-by-dep
avg_comparisons(
  mod_rq_int,
  variables = "trt",
  by = "dep_bin"
)
```

## Marginal median treatment effects

```{r}
#| label: rq-avg-comparisons-int-marginal
avg_comparisons(
  mod_rq_int,
  variables = "trt"
)
```

# Visualization

## Group means (additive vs interaction model)

```{r}
#| label: plot-means-additive
p_add <- plot_predictions(
  mod_lm_add,
  by = c("trt", "dep_bin")
) +
  geom_line(
    aes(trt, estimate, group = dep_bin, color = dep_bin),
    position = position_dodge(0.1)
  ) +
  labs(
    x = "Treatment group",
    y = "Estimated Mean LSAS (95% CI)",
    color = "Depression",
    title = "Additive Model"
  ) +
  ylim(40, 95) +
  theme_minimal()
```

```{r}
#| label: plot-means-interaction
#| fig-width: 10
library(patchwork)
p_int <- plot_predictions(
  mod_lm_int,
  by = c("trt", "dep_bin")
) +
  geom_line(
    aes(trt, estimate, group = dep_bin, color = dep_bin),
    position = position_dodge(0.1)
  ) +
  labs(
    x = "Treatment group",
    y = "Estimated Mean LSAS (95% CI)",
    color = "Depression",
    title = "Interaction Model"
  ) +
  ylim(40, 95) +
  theme_minimal()

p_add + p_int + plot_layout(guides = "collect", axes = "collect")
```

Here we see the difference between the additive and the interaction model clearly. Since the additive model assumed additivity, the lines are exactly parallel (i.e., the treatment effect is the same for the low vs high depression group). In the interaction model, we have allowed the treatment effects to differ by depression level, and we see that the high-depression group improves more than the low depression group.

# Summary

In this chapter you learned:

-   how to fit regression models with **two binary predictors**
-   the meaning of **conditional effects**
-   the difference between additive and interaction models
-   how interactions change coefficient interpretation
-   how to estimate conditional effects using `marginaleffects`
-   how to visualize interactions using predicted values

This chapter completes the foundation for understanding **effect modification**, which is essential for applied regression and causal interpretation.
