---
title: "testing two means and contingency tables"
format: html
---

In this lab we focus on testing differences between groups. Previously we have calculated p-values and confidence intervals for one-sample means and proportions. In psychiatric research, we are more often interested in comparing means between groups. For instance, the post-treatment symptom levels between the treatment group and the control group.

## Testing the mean difference of two independent groups

In the STepS study, a primary comparison was the severity of social anxiety symptoms post-treatment between the self-guided and the therapist-guided treatment groups. As a first check, we can load the data and calculate get some descriptive statistics for the post-treatment LSAS-scores across the treatment groups.

```{r}
#| label: load-packages
#| message: false

library(tidyverse)
library(here)
library(janitor)
```

```{r}
#| message: false
df_data <- read_csv(here("data", "steps_clean.csv"))
```

And create a nicer, factor-level, treatment indicator variable

```{r}
df_data$trt <- trt <- factor(df_data$group,
              levels = c(0, 1, 2),
              labels = c("waitlist", "self-guided", "therapist-guided"))


```

And check the mean post-treatment LSAS-score across the groups

```{r}
df_data %>%
  group_by(trt) %>%
  summarise(
    n      = n(),
    mean   = mean(lsas_post, na.rm = TRUE),
    sd     = sd(lsas_post, na.rm = TRUE)
  )
     
```

We see that the therapist-guided groups has the lowest treatment scores post-treatment. We can also do a simple check of differences in the mean values across the groups of interest.

```{r}
  mean(df_data$lsas_post[df_data$trt=="self-guided"], na.rm=TRUE) -
    mean(df_data$lsas_post[df_data$trt=="therapist-guided"], na.rm=TRUE) 

```

So the mean values of LSAS-scores is 7.6 point higher in the treatment group receiving self-guided treatment compared to the group receiving therapist-guided treatment. However, we still do not know how likely this difference is to have occurred by chance. For this we need a statistical test!

To test the difference between two means, we can use an independent group t-test

$$
t = \frac{\bar{X}_1 - \bar{X}_2}{\sqrt{\frac{s_1^2}{n_1} + \frac{s_2^2}{n_2}}}
$$

Rather than comparing the mean value against some value of interest, as in the one-sample t-test, here we compare the means of two groups against each other. Usually this is done under the nullhypothesis:

$$
H_{0}: \mu_{\text{therapist-guided}} = \mu_{\text{self-guided}}
$$

and the alternative hypothesis:

$$
H_{A}: \mu_{\text{therapist-guided}} \neq \mu_{\text{self-guided}}
$$

So let's use the formula above to calculate a t-value.

```{r}
# define the components of the t-test formula
x_bar_tg <- mean(df_data$lsas_post[df_data$trt=="therapist-guided"], na.rm=T)
x_bar_sg <- mean(df_data$lsas_post[df_data$trt=="self-guided"], na.rm=T)
s_2_tg <- var(df_data$lsas_post[df_data$trt=="therapist-guided"], na.rm=T)
s_2_sg <- var(df_data$lsas_post[df_data$trt=="self-guided"], na.rm=T)
n_tg <- sum(!is.na(df_data$lsas_post[df_data$trt=="therapist-guided"])) # here we only count the number of persons that provided data
n_sg <- sum(!is.na(df_data$lsas_post[df_data$trt=="self-guided"])) # here we only count the number of persons that provided data


# and put the together
t_value <- (x_bar_sg - x_bar_tg) / sqrt((s_2_tg/n_tg ) + (s_2_sg/n_sg ))
t_value
```

From the t-value, we can get the p-value in the same way as with the one-sample t-value, that we used previously.

```{r}
df <- n_tg + n_sg - 2
p_value <- 2 * (1 - pt(abs(t_value), df))
p_value
```

Or use the `t_test()` function, and filter to using only the self-guided and therapist-guided groups

```{r}
df_data %>%
  filter(trt != "waitlist") %>%
  t.test(lsas_post ~ trt, data = ., var.equal = FALSE)
```

::: callout-note
## Assumptions of an Independent Groups *t*-test

1.  **Independence of observations**
    -   The two groups must be independent (no participant in both groups, no repeated measures).
2.  **Scale of measurement**
    -   The dependent variable should be continuous (interval or ratio).
    -   The independent variable should be categorical with two groups.
3.  **Normality**
    -   The dependent variable in each group should be approximately normally distributed.
    -   More critical for small samples; larger samples benefit from the Central Limit Theorem.
4.  **Homogeneity of variance**
    -   Both groups should have equal variances.
    -   If violated, use Welchâ€™s *t*-test instead (this is in fact the one we have calculated above)
5.  **Random sampling**
    -   Ideally, groups are randomly sampled or randomly assigned in an experiment.
:::

We could also calculate the confidence interval of the mean difference between the groups, using the formula using the t-value:

$$
\left( \, (\bar{X}_1 - \bar{X}_2) \; \pm \; t_{\alpha/2, \, df} \times 
\sqrt{\frac{s_1^2}{n_1} + \frac{s_2^2}{n_2}} \, \right)
$$

Or the z-value, id the sample is large:

$$
\left( \, (\bar{X}_1 - \bar{X}_2) \; \pm \; Z_{\alpha} \times 
\sqrt{\frac{s_1^2}{n_1} + \frac{s_2^2}{n_2}} \, \right)
$$

Where the following part of the formula represents the *standard error of the mean difference.*

$$
\sqrt{\frac{s_1^2}{n_1} + \frac{s_2^2}{n_2}} 
$$

Putting this together, we get the confidence interval for the mean difference.

```{r}
#with t-values
# define the components of the t-test formula
x_bar_tg <- mean(df_data$lsas_post[df_data$trt=="therapist-guided"], na.rm=T)
x_bar_sg <- mean(df_data$lsas_post[df_data$trt=="self-guided"], na.rm=T)
s_2_tg <- var(df_data$lsas_post[df_data$trt=="therapist-guided"], na.rm=T)
s_2_sg <- var(df_data$lsas_post[df_data$trt=="self-guided"], na.rm=T)
n_tg <- sum(!is.na(df_data$lsas_post[df_data$trt=="therapist-guided"])) # here we only count the number of persons that provided data
n_sg <- sum(!is.na(df_data$lsas_post[df_data$trt=="self-guided"])) # here we only count the number of persons that provided data
se_diff <- sqrt((s_2_tg/n_tg ) + (s_2_sg/n_sg )) # save the SE of the difference as a separate object for conveninence

# and put it together with the z-value formula, where z_values of 1.96 represents 95% confidence intervals

ucl <- (x_bar_sg - x_bar_tg) + 1.96*se_diff
lcl <- (x_bar_sg - x_bar_tg) - 1.96*se_diff
print(c(lcl, ucl))
```

```{r}

```

::: {.callout-caution collapse="\"true"}
## Exercise: Testing independent group means

1.  Compare the confidence intervals calculated by hand using the z-value approach to those from the `t_test()` function, and describe why they are different
2.  Calculate the mean difference, and the associated two-sided p-value for the mean difference between the therapist-guided and the wait list group
3.  Complement this with the 95% confidence interval.
4.  Do you think the assumption of equal variance between the groups is justifies?
5.  Do you think the assumptions of the t-test are fulfilled?
:::

```{r}
df_data %>%
  filter(trt != "waitlist") %>%
  t.test(lsas_post ~ trt, data = ., var.equal = FALSE)
```

## Testing dependent means

The independent group t-test assumes that the groups compared are independent, which is the case for the two treatment groups. Sometimes, however, we want to compare the means of dependent groups. This could be for instance the difference in means between two time-point of the same group. Then we can use a paired-sample t-test.

For a paired samples *t*-test, the statistic is:

$$
t = \frac{\bar{D}}{s_D / \sqrt{n}}
$$

where:

-   $\bar{D}$ = mean of the difference scores
-   $s_D$ = standard deviation of the difference scores
-   $n$ = number of paired observations

We could use this to formula to test the difference in LSAS-scores from pre-to post-treatment.

```{r}
diff_pre_post <- df_data$lsas_post - df_data$lsas_screen
mean_diff <- mean(diff_pre_post, na.rm=TRUE)
sd_diff <- sd(diff_pre_post, na.rm=TRUE)
n <- sum(!is.na(diff_pre_post))
t_value <- mean_diff / (sd_diff/sqrt(n))
t_value
```

And get the two-tailed p-value from this as before

```{r}
df <- n -1 
p_value <- 2 * (1 - pt(abs(t_value), df))
p_value
```

Or using the `t_test()` function.

```{r}
t.test(df_data$lsas_post, df_data$lsas_screen, paired = TRUE)
```

We can also get the confidence intervals of this difference, using the formula:

$$
\bar{D} \; \pm \; t_{\alpha/2, \, df} \cdot \frac{s_D}{\sqrt{n}}
$$

Or with the z-value for large samples:

$$
\bar{D} \; \pm \; z \cdot \frac{s_D}{\sqrt{n}}
$$

Manually, we can get the 95% confidence intervals using the z-value approach.

```{r}
diff_pre_post <- df_data$lsas_post - df_data$lsas_screen
mean_diff <- mean(diff_pre_post, na.rm=TRUE)
sd_diff <- sd(diff_pre_post, na.rm=TRUE)
n <- sum(!is.na(diff_pre_post))
se_diff <- (sd_diff/sqrt(n)) # saving the stadard error of the difference as a separate object for convenience

# and putting it together
lcl <- mean_diff - 1.96*se_diff
ucl <- mean_diff + 1.96*se_diff
print(c(lcl, ucl))
```

::: {.callout-caution collapse="\"true"}
## Exercise: Testing dependent group means

1.  Compute a t-test for the difference in LSAS-scores between post-treatment and 12-month follow-up and provide an interpretation of its meaning
2.  Also calculate the 95% confidence interval for this difference, using the z-value formula and provide an interpretation of its meaning
3.  Compare the means of GAD-7 from pre- to post-treatment present your inferences.
:::

## Contingency tables
